<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>B站收藏夹分析</title>
    <meta name="description" content="B站收藏夹数据分析工具">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root {
            --primary-color: #00a1d6;
            --secondary-color: #23ade5;
            --background-color: #f4f5f7;
            --text-color: #333;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 2rem;
        }

        .input-section {
            margin-bottom: 2rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        input[type="text"] {
            width: 100%;
            padding: 0.8rem;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
            margin-bottom: 1rem;
        }

        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 0.8rem 2rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
        }

        .hidden {
            display: none;
        }

        #charts, #mindmap {
            height: 400px;
            margin-top: 2rem;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .stat-item {
            background: #f5f5f5;
            padding: 1rem;
            border-radius: 4px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container" role="main" aria-label="主要内容">
        <h1>B站收藏夹分析工具</h1>
        
        <div class="input-section">
            <div class="form-group">
                <label for="fav-url" aria-label="收藏夹链接输入框">收藏夹链接：</label>
                <input type="text" 
                       id="fav-url" 
                       name="fav-url"
                       aria-label="收藏夹链接输入框"
                       value="https://space.bilibili.com/56671097/favlist?fid=99042297"
                       required>
                <button onclick="analyzeFavorites()" aria-label="开始分析按钮">开始分析</button>
            </div>
        </div>

        <div id="loading" class="hidden" role="alert" aria-live="polite">
            <p>正在分析中，请稍候...</p>
        </div>

        <div id="result" class="hidden" role="region" aria-label="分析结果">
            <div class="stats-section">
                <h2>基础统计</h2>
                <div id="basic-stats" aria-live="polite"></div>
            </div>

            <div class="charts-section">
                <h2>数据可视化</h2>
                <div id="charts" aria-label="播放量统计图表"></div>
            </div>

            <div class="mindmap-section">
                <h2>思维导图</h2>
                <div id="mindmap" aria-label="视频关系思维导图"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/echarts@5.2.2/dist/echarts.min.js"></script>
    <script>
        async function analyzeFavorites() {
            const loading = document.getElementById("loading");
            const result = document.getElementById("result");
            const favUrl = document.getElementById("fav-url").value;

            try {
                loading.classList.remove("hidden");
                result.classList.add("hidden");

                const { uid, fid } = parseFavUrl(favUrl);
                const data = await fetchFavoriteList(uid, fid);
                
                if (data) {
                    updateBasicStats(data);
                    drawCharts(data);
                    createMindmap(data);
                    
                    loading.classList.add("hidden");
                    result.classList.remove("hidden");
                }
            } catch (error) {
                alert("分析失败：" + error.message);
                loading.classList.add("hidden");
            }
        }

        function parseFavUrl(url) {
            const regex = /space\.bilibili\.com\/(\d+)\/favlist\?fid=(\d+)/;
            const match = url.match(regex);
            
            if (!match) {
                throw new Error("无效的收藏夹链接");
            }

            return {
                uid: match[1],
                fid: match[2]
            };
        }

        async function fetchFavoriteList(uid, fid) {
            return new Promise((resolve, reject) => {
                const callbackName = "jsonpCallback_" + Date.now();
                window[callbackName] = function(data) {
                    delete window[callbackName];
                    document.head.removeChild(script);
                    resolve(data.data);
                };

                const script = document.createElement("script");
                script.src = `https://api.bilibili.com/x/v3/fav/resource/list?media_id=${fid}&pn=1&ps=20&jsonp=jsonp&callback=${callbackName}`;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        function updateBasicStats(data) {
            const basicStats = document.getElementById("basic-stats");
            const medias = data.medias || [];
            
            basicStats.innerHTML = `
                <div class="stat-grid">
                    <div class="stat-item">
                        <h3>视频总数</h3>
                        <p>${medias.length}</p>
                    </div>
                    <div class="stat-item">
                        <h3>总播放量</h3>
                        <p>${medias.reduce((sum, video) => sum + (video.cnt_info?.play || 0), 0)}</p>
                    </div>
                    <div class="stat-item">
                        <h3>平均时长</h3>
                        <p>${calculateAvgDuration(medias)}</p>
                    </div>
                </div>
            `;
        }

        function drawCharts(data) {
            const chartsDiv = document.getElementById("charts");
            const chart = echarts.init(chartsDiv);
            const medias = data.medias || [];
            
            const option = {
                title: {
                    text: "视频播放量分布"
                },
                tooltip: {
                    trigger: "axis"
                },
                xAxis: {
                    type: "category",
                    data: medias.map(video => video.title)
                },
                yAxis: {
                    type: "value"
                },
                series: [{
                    data: medias.map(video => video.cnt_info?.play || 0),
                    type: "bar"
                }]
            };
            
            chart.setOption(option);
        }

        function createMindmap(data) {
            const mindmapDiv = document.getElementById("mindmap");
            const mindmap = echarts.init(mindmapDiv);
            const medias = data.medias || [];
            
            const mindmapData = {
                name: "B站收藏夹",
                children: medias.map(video => ({
                    name: video.title,
                    children: [
                        { name: `播放量: ${video.cnt_info?.play || 0}` },
                        { name: `收藏数: ${video.cnt_info?.collect || 0}` },
                        { name: `时长: ${formatDuration(video.duration)}` }
                    ]
                }))
            };
            
            const option = {
                series: [{
                    type: "tree",
                    data: [mindmapData],
                    layout: "radial",
                    symbolSize: 7,
                    label: {
                        position: "right",
                        verticalAlign: "middle",
                        align: "left"
                    }
                }]
            };
            
            mindmap.setOption(option);
        }

        function calculateAvgDuration(medias) {
            const totalDuration = medias.reduce((sum, video) => sum + (video.duration || 0), 0);
            return formatDuration(totalDuration / medias.length);
        }

        function formatDuration(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.floor(seconds % 60);
            return `${minutes}:${remainingSeconds.toString().padStart(2, "0")}`;
        }
    </script>
</body>
</html>
